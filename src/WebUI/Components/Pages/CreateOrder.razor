@page "/orders/create"
@inject PaymentPlatformClient Client
@inject OrderTracker Tracker
@inject NavigationManager Nav

<div class="page-header">
    <h1>âž• Create Order</h1>
    <p>Submit a new payment order. This triggers the authorization flow via RabbitMQ.</p>
</div>

<div class="card" style="max-width: 600px;">
    <div class="form-group">
        <label>Customer ID</label>
        <input class="form-control mono" @bind="_customerId" placeholder="Auto-generated GUID" />
    </div>

    <div class="form-row">
        <div class="form-group">
            <label>Amount</label>
            <input type="number" step="0.01" min="0.01" class="form-control" @bind="_amount" />
        </div>
        <div class="form-group">
            <label>Currency</label>
            <select class="form-control" @bind="_currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
            </select>
        </div>
    </div>

    <div class="alert alert-info">
        <strong>ðŸ’¡ Tip:</strong> Amounts ending in <code>.99</code> will be <strong>declined</strong> (simulated).
        Amounts over <strong>$10,000</strong> will timeout. This tests the failure handling paths.
    </div>

    <div class="actions">
        <button class="btn btn-primary" @onclick="SubmitOrder" disabled="@_submitting">
            @if (_submitting) { <span class="spinner"></span> } else { <span>ðŸ’³</span> }
            Create Order & Authorize Payment
        </button>
    </div>
</div>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert @_messageClass mt-2">@_message</div>
}

@code {
    private string _customerId = Guid.NewGuid().ToString();
    private decimal _amount = 250.00m;
    private string _currency = "USD";
    private bool _submitting;
    private string? _message;
    private string _messageClass = "alert-info";

    private async Task SubmitOrder()
    {
        _submitting = true;
        _message = null;
        StateHasChanged();

        try
        {
            var idempotencyKey = Guid.NewGuid().ToString();
            var request = new CreateOrderRequest(
                Guid.Parse(_customerId),
                _amount,
                _currency,
                idempotencyKey);

            var result = await Client.CreateOrderAsync(request);

            if (result is not null)
            {
                Tracker.Track(new TrackedOrder
                {
                    OrderId = result.OrderId,
                    CustomerId = Guid.Parse(_customerId),
                    Amount = _amount,
                    Currency = _currency,
                    Status = result.Status,
                    IdempotencyKey = idempotencyKey,
                    CreatedAt = DateTime.UtcNow
                });

                _message = $"Order {result.OrderId} created with status '{result.Status}'. " +
                           "Payment authorization is processing via RabbitMQâ€¦";
                _messageClass = "alert-success";

                // Reset for next order
                _customerId = Guid.NewGuid().ToString();
            }
        }
        catch (Exception ex)
        {
            _message = $"Failed to create order: {ex.Message}";
            _messageClass = "alert-danger";
        }
        finally
        {
            _submitting = false;
        }
    }
}
